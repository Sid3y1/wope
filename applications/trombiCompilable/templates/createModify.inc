<?php
/**
*		Copyright	: (C) 2006 Geniutt SARL
*		Licence		: GNU GPL
*		Email       : contact@geniutt.fr
*		Version		: 8.0
*
*		This program is free software; you can redistribute it and/or modify
*		it under the terms of the GNU General Public License as published by
*		the Free Software Foundation; either version 2 of the License, or   
*		(at your option) any later version.                                 
*			                                                           
*		This program is distributed in the hope that it will be useful,     
*		but WITHOUT ANY WARRANTY; without even the implied warranty of      
*		MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the       
*		GNU General Public License for more details.                        
*				                                                           
*		You should have received a copy of the GNU General Public License   
*		along with this program; if not, write to the Free Software         
*		Foundation, Inc., 59 Temple Place, Suite 330, Boston,               
*		MA  02111-1307  USA
*	
*		Generated by trombiCompilable                                                 
*
**/

function getValue($values, $nom) {
	if (isset($_POST[$nom])){
		if (get_magic_quotes_gpc()) {
			return stripslashes($_POST[$nom]);
		} else {
			return $_POST[$nom];
		}
	} elseif (isset($values[$nom])) {
		return stripslashes(html_entity_decode($values[$nom], ENT_QUOTES, 'UTF-8'));
	} else {
		return "";
	}	
}

function getError($error,$id) {
	if (isset($error[$id])) {
		return $error[$id];
	} else {
		return "";
	}
}


$core->loadClass('filemanager');
$locale=Locale::getLocale();


$error = Array();
$values = Array();
$displayErrors = false;
	
if( isset($idUser) && $idUser != "" ){
	$idUser = (int)$_GET["id_user"];
	if( !$core->verifDroits('admin') ){
		echo $locale->display('no_page_right','kernel');
		$page->footer();
		exit();
	}
} else {
	$idUser = $core->getUserId();	
}


$query="SELECT count(id) as nb FROM trombi_trombi WHERE id_user='$idUser'";
$result=$db->query($query);

if ($db->result($result,"nb")==1) {
	$query="SELECT * FROM trombi_trombi WHERE id_user='$idUser'";
	$result=$db->query($query);
	$values = $db->fetchArray($result,MYSQL_ASSOC);
	$idTrombi=$values['/*idName*/'];
	$mode="UPDATE";
} else {
	$mode="INSERT";
}


if (isset($_POST['save'])){

	//recovers the files manager in the session
	if( isset($_POST['fm_id']) && isset($_SESSION['file_manager_'.$_POST['fm_id']]) ){
		$fm = unserialize($_SESSION['file_manager_'.$_POST['fm_id']]);
		$save_files = true;
	//or creates it
	}else{
		$fm = new FileManager();
		$save_files = false;
	}
	
	$valid=true;
	$falsevalid=false;
	
	//saves files if existing
	if($save_files){
		$photo_ids = $fm->saveOrGet('image', 'log', 'log');
	}
	
	
	/*validate*/


	if( $valid ){
		$query = $mode." trombi_trombi SET id_user='".$core->getUserId()."', /*sql*/";
		if( $mode == "UPDATE" ){
			$query .= "WHERE /*idName*/='$idTrombi'";	
		} else {
			$query .= "";		
		}
		if( $db->query($query) ){
			$page->msgInfo($locale->display('card_saved','trombi'));
			if( !$falsevalid ){
				//$core->url->redirect("/*relRep*/");
			}	
		} else {
			$page->msgError($locale->display('data_error','trombi'));	
		}
	} else {
		$displayErrors = true;
	}
	
//first posting of the form
}else{
	$fm = new FileManager();
}


if (isset($_GET['id_user'])) {
	$action = "?id_user=".urlencode($_GET['id_user']);
} else {
	$action = "";
}


/*preform*/


//menu
echo '<div class="admin_menu1">';
$page->moduleHeader('Actions','');

echo '<script type="text/javascript">';
echo 'function hideAllPersonnalInfo() {';
foreach ($tabs_array as $tab) {
	echo 'hide(document.getElementById(\''.sha1($tab).'\'));';
}
echo '}';
echo '</script>';
echo '<ul class="panel">';

foreach ($tabs_array as $tab) {
	echo '<li><a onclick="javscript:hideAllPersonnalInfo();show(document.getElementById(\''.sha1($tab).'\'))">'.$tab.'</a></li>';
}
$page->moduleFooter();
echo '</div>';


//content : forms
echo '<div id="admin_info_content" class="admin_menu2">';

if( $displayErrors ){
	$err_msg = '<div><dl>';

/*displayErrors*/

	$err_msg .= '</dl></div>';
	$page->msgError('<div>'.$locale->display('data_error','trombi').'</div>'.$err_msg);
}


do{
  $fm_id=rand(1000000, 9999999);
}while( isset($_SESSION['file_manager_'.$fm_id]) );

?>
<form action="<?=$action?>" method="post" enctype="multipart/form-data">
	<div class="input-hidden">
		<input type="hidden" name="fm_id" value="<?=$fm_id?>" />
	</div>

/*form*/

</form>
<?

echo '</div>';


echo '<script type="text/javascript">';
echo 'hideAllPersonnalInfo();';
$tab = array_shift($tabs_array);
echo 'show(document.getElementById(\''.sha1($tab).'\'));';
echo '</script>';


//saves file manager in session
$_SESSION['file_manager_'.$fm_id] = serialize($fm);

?>
