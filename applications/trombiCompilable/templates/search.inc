<?php

/**
*		Copyright	: (C) 2006 Geniutt SARL
*		Licence		: GNU GPL
*		Email       : contact@geniutt.fr
*		Version		: 8.0
*
*		This program is free software; you can redistribute it and/or modify
*		it under the terms of the GNU General Public License as published by
*		the Free Software Foundation; either version 2 of the License, or   
*		(at your option) any later version.                                 
*			                                                           
*		This program is distributed in the hope that it will be useful,     
*		but WITHOUT ANY WARRANTY; without even the implied warranty of      
*		MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the       
*		GNU General Public License for more details.                        
*				                                                           
*		You should have received a copy of the GNU General Public License   
*		along with this program; if not, write to the Free Software         
*		Foundation, Inc., 59 Temple Place, Suite 330, Boston,               
*		MA  02111-1307  USA
*	
*		Generated by trombiCompilable                                                 
*
**/


function afficheNbPage($href, $num_page, $nb_row) {
	$locale = Locale::getLocale();
	global $limit,$core;
	$core->loadClass('htmlblock');
	$hb = new HtmlBlock();
	$hb->pagesList((int)$nb_row, (int)$limit, (int)$num_page, 'href', $href, $locale->display('page','kernel'));
}


function getValue($name) {
	if( isset($_POST[$name]) ){
		return mysql_escape_string($_POST[$name]);
	} else {
		return "";
	}	
}


function isCardMine($id_card){
	global $core, $db;
	
	$myCardsResult = $db->query("SELECT id FROM trombi_trombi WHERE id_user = '".$core->getUserId()."' ");
	if( isset($myCardsResult) ){
	  while( $row = $db->fetchArray($myCardsResult) ){
			if( $row['id'] == $id_card ){
				return true;
			}
		}
	}

	return false;
}

function logCardVisit($id_card){
	global $core, $db;
	$ret = false;


	$result = $db->query("SELECT COUNT(*) FROM trombi_visit WHERE id_card = '".$id_card."' AND id_user = '".$core->getUserId()."' ");
	if( isset($result) ){
		if( $db->result($result, 0) == 1 ){
			if($db->query("UPDATE trombi_visit SET visits_count = visits_count + 1 WHERE id_card = '".$id_card."' AND id_user = '".$core->getUserId()."' ")){
				$ret = true;
			}
		}else{
			if($db->query("INSERT trombi_visit (id_card, id_user) VALUES ('".$id_card."', '".$core->getUserId()."') ")){
				$ret = true;
			}
		}
	}
	
	return $ret;
	
}

$SECU = "log";
$LOCALE = "trombi";

include ("../include/config.inc");
include (dirname(__FILE__).'/config_trombi.inc');

$ARIANEWIRE = Array (
	"Accueil" => $core->makeUrl('index.php'),
	"Trombi" => "index.php"
);

$locale = Locale::getLocale();
$page = new Page();
$page->header($locale->display('trombi','kernel'), 'trombi');

$core->loadClass('filemanager');
$core->loadClass('trombi');
$core->loadClass('link');
$core->loadClass('tabs');
$core->loadClass('htmlblock');

$box=new Box();
$fm = new FileManager();
$trombi = new Trombi();
$link = new Link();
$hb = new HtmlBlock();

$secret="/*secret*/";

$limit= $core->user->getMyPref('trombi_limit');
$limit= ($limit < 10) ? 10 : $limit;

$photo= $core->user->getMyPref('trombi_photo');

$page->adminLink('user', 'default', $config_trombi['admin_rights']);
?>
<div class="clear"></div>
<div class="colomn1">
<?php
$page->moduleHeader($locale->display('seek','kernel'),'');
$menu_search= new Tabs(Array('simple'=>$locale->display('simple_seek','trombi'),'advanced'=>$locale->display('advanced_seek','trombi')));
$menu_search->display();
$menu_search->separatorStart("simple");
?>
<form action="" method="POST" id="fasesearchForm">
	<div class="input-hidden"><input type="hidden" name="ga" value="fs" /></div>
	<p><input type="text" size="15" id="fastsearch" name="fastsearch" value="<?=getValue("fastsearch");?>">
  <input type="submit" value="<?=$locale->display('seek','kernel')?>"></p>
  <p><a class="link_button" href="javascript:gE('fastsearch').value='';gE('fasesearchForm').submit();void(0);" ><?=$locale->display('see_all','trombi')?></a></p>
  <div class="autocomplete_container" id="trombi_autocomplete"></div> 
</form>
<script type="text/javascript"> 
	var phpFile = "./ajax/fastsearch.php";
	var schema = ["results", "value","data"]; 
	var trombi_datasource = new YAHOO.widget.DS_XHR(phpFile, schema); 
	var trombiAutoComp = new YAHOO.widget.AutoComplete("fastsearch","trombi_autocomplete", trombi_datasource); 
	trombiAutoComp.minQueryLength = 3;
	trombiAutoComp.animVert = false;
	trombiAutoComp.animHoriz = false;
	YAHOO.widget.AutoComplete.prototype.formatResult = function(aResultItem, sQuery) { 
	    var sResult = aResultItem[0]; 
	    if(sResult) { 
	        return sResult+aResultItem[1]; 
	    } 
	    else { 
	        return ""; 
	    } 
	}; 
</script> 
<?php
$menu_search->separatorStop("simple");
$menu_search->separatorStart("advanced");
?>
<div id="advance_search">
	<div class="trombi_options_supp">
	  	<form action="" method="POST">
				<div class="input-hidden"><input type="hidden" name="ga" value="s" /></div>
				/*searchform*/
		</form>
	</div>
</div>
<?php
$menu_search->separatorStop("advanced");
$page->moduleFooter();
$page->moduleHeader($locale->display('options','kernel'), 'libre');

$infos_header = $locale->display('infos_perso','trombi');
echo "<ul class='panel'>
	<li><a href='".$core->makeUrl("/user/index.php?part=info")."'><span>".substr($infos_header, 0, 1)."</span>".substr($infos_header, 1)."</a></li>
</ul>";
$page->moduleFooter();
?>
</div>
<div class="colomn2">
<?php



$query= "SELECT COUNT(*) FROM trombi_trombi LEFT JOIN usersInfo ON trombi_trombi.id_user = usersInfo.id WHERE ";
$url="index.php?page=[#]";
$num_page=1;

if ( isset ($_POST["fastsearch"]) ) {
	$my_query = "LOWER(usersInfo.login) LIKE CONCAT('%',LOWER('".$db->escapeString(getValue('fastsearch'))."'),'%') 
		OR LOWER(CONCAT(firstname, ' ',lastname)) LIKE CONCAT('%',LOWER('".$db->escapeString(getValue('fastsearch'))."'),'%') 
		OR LOWER(CONCAT(lastname, ' ',firstname)) LIKE CONCAT('%',LOWER('".$db->escapeString(getValue('fastsearch'))."'),'%') /*fastsearchsql*/ ";
	$query .= $my_query;
	$sha = sha1($my_query.$secret);
	$_SESSION['trombi_query_'.$sha] = $my_query;
	$url .= "&amp;query=1&amp;sha=".$sha;
	
} elseif ( isset ($_POST["search"]) ) {

	$my_query = "1 /*searchsql*/";
	$query .= $my_query;
	$sha = sha1($my_query.$secret);
	$_SESSION['trombi_query_'.$sha] = $my_query;
	$url .= "&amp;query=1&amp;sha=".$sha;
	
} elseif( isset($_GET["query"]) && $_GET["query"]=='1' ) {

	if ( isset($_GET['sha']) && $_GET['sha'] == sha1($_SESSION['trombi_query_'.$_GET['sha']].$secret) ) {
		$my_query = $_SESSION['trombi_query_'.$_GET['sha']];
		$query .= $my_query;
		$url .= "&amp;query=1&amp;sha=".$_GET['sha'];
		$num_page = intval($_GET["page"]);
	} else {
		$query = null;
	}
	
} else {

	$query = null;
	
}

$action = isset($_POST['ga']) ? $_POST['ga'] : (isset($_GET['ga']) ? $_GET['ga'] : '');

//'cd' = 'display card', 's' = 'search'
if( $action != 'dc' ){
	if ($query != null) {
		$result = $db->query($query);
		$nb_result = $db->result($result, 0);
	}

	if ($query == null){
		$members_nb = $db->result($db->query('SELECT COUNT(*) FROM usersInfo WHERE id <> 1 '), 0);
		$query = "SELECT trombi_trombi.* FROM trombi_trombi LEFT JOIN usersInfo ON trombi_trombi.id_user = usersInfo.id WHERE trombi_trombi.id > ( SELECT CAST(Max(id)-5 as signed) FROM trombi_trombi ) ORDER BY usersInfo.id DESC ";
		$result = $db->query($query);
		$page->moduleHeader($locale->display('last_added', 'trombi'), 'droite');
		echo '<div class="members_nb">Aujourd\'hui : '.$members_nb.' membres inscrits sur le site.</div>';
		echo '<div class="user-list">';
		while ($value= $db->fetchArray($result, MYSQL_ASSOC)) {
?>
	/*showresult*/
<?php

		}
		echo "</div>";
		$page->moduleFooter();

	} elseif  ($nb_result == 0) {

		$page->msgInfo(locale :: display('no_result', 'trombi'));
	
	} else {

		$query = "SELECT trombi_trombi.* FROM trombi_trombi LEFT JOIN usersInfo ON trombi_trombi.id_user = usersInfo.id WHERE (";
		$query .= $my_query.") ORDER BY trombi_trombi.lastname ASC LIMIT ".(($num_page - 1)*$limit).",".($limit);
		$result = $db->query($query);
		$page->moduleHeader($locale->display('search_result', 'trombi').' : '.$nb_result.' '.$locale->display('results', 'trombi'), 'droite');
		$url .= '&amp;ga=s';
		afficheNbPage($url, $num_page, $nb_result);
		echo '<dl class="user-list">';
	
		while ($value= $db->fetchArray($result, MYSQL_ASSOC)) {
?>
	/*showresult*/
<?php

		}
		echo "</dl>";
		afficheNbPage($url, $num_page, $nb_result);
		$page->moduleFooter();
	
	}
	
}else{

	if( isset($_GET['c']) ){

		if( !isCardMine($_GET['c']) ){
			logCardVisit($_GET['c']);
		}
		
		$query = "SELECT * FROM trombi_trombi WHERE trombi_trombi.id = '".$_GET['c']."' ";
		$result = $db->query($query);
		$value = $db->fetchArray($result);
		
		$strName = ucwords(strtolower(stripslashes($value['firstname'].' '.$value['lastname'])));
		$page->moduleHeader(ucwords($locale->display('trombi_card', 'trombi')).' : '.$strName, 'droite');
		
		echo '';
		
		echo '
		<div class="trombi_card">'
				.'<div class="header_block">'
						.'<div class="search_icon_block">'
								.'<span class="icon_search">&nbsp;</span>'
								.'<a class="search" alt="search icon" href="'.str_replace('[#]', $num_page, $url).'&amp;ga=s#result_'.$value['id'].'">Retourner à la recherche</a>'
						.'</div>'
						.'<div class="clear"></div>'
						.'<div class="user_photos_block">'
								.$trombi->displayUserPhotos($value['id_user'])
						.'</div>'
						.'<div class="clear"></div>';
		
		//preloads photo
		$photo = $fm->preview($value['photo'], 3, true);
  	echo '<span style="display: none;">'.$photo.'</span>';
		
	  echo '
			<div class="email_block">'.$link->mailto(stripslashes($value['email']), 'Contacter', 'mini_mail').'</div>
			<div class="photo_block"><div class="picture_block"><a class="avatar"';

		if( isset($value['photo']) && $value['photo'] != '' ){
			echo ' onclick="dialBox.draw(\''.
				$page->htmlBlock->escapeTipContent('<div class="close_avatar_prev"><a class="link_button" onclick="dialBox.erase()">Fermer</a></div><div>'.$photo.'</div>').
				'\', \''.$strName.'\', true);" ';
		}
		
		echo ' ><span></span>'.$fm->preview($value['photo'], 1, true).'</a>
			</div></div>';
		
		echo '
			<div class="summary_block">
				<div class="name_line"><h3>'.$strName.'</h3>';

				if( isset($value['signal_social']) && $value['signal_social'] != '' ){
				  echo '<span class="social_status">'.stripslashes($value['signal_social']).'</span>';
				}
		
				echo '
				</div>
				<div class="summary_infos">';
				if( isset($value['company_name']) && $value['company_name'] != '' ){
					echo ($value['position'] != '' ? '<h4>'.stripslashes($value['position']).'</h4>' : '').
					'<h4>'.stripslashes($value['company_name']).'</h4>';
				}
				echo '
					<p>'.stripslashes($value['city']).'</p>
				</div>
			</div>
			<div class="clear"></div>
		</div>
		<div class="clear"></div>
			
			<div class="main_block">
		';
		
		if( isset($config_trombi['cv']) && $config_trombi['cv'] ){
			$cv = true;
			$core->loadClass('tabs');
			$tabs = new Tabs( Array('main' => 'Contact', 'cv' => 'CV') );
			$tabs->display();
			$tabs->separatorStart('main');
		}else{
			$cv = false;
		}
		
?>
		/*showcard*/
<?php

		if( $cv ){
			$tabs->separatorStop('main');
			$tabs->separatorStart('cv');
?>
		<h3>Formation</h3>
		<div><?=stripslashes($value['studies'])?></div>
		<h3>Expérience</h3>
		<div><?=stripslashes($value['professional_history'])?></div>
		<h3>Langues et informatique</h3>
		<div><?=stripslashes($value['languages'])?></div>
		<h3>Informations complémentaires</h3>
		<div><?=stripslashes($value['history_freespace'])?></div>
<?php
			$tabs->separatorStop('cv');
		}
		
		echo '
			</div>
		</div>';
	
		$page->moduleFooter();
	}
	
}

?>
</div>
<?

$page->footer();
?>
